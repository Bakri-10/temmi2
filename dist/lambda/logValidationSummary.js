"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const { S3Client, GetObjectCommand, ListObjectsCommand } = require("@aws-sdk/client-s3");
const cchLambdaLogger_1 = require("./cchLambdaLogger");
const s3Client = new S3Client({ region: process.env.REGION });
// File to string helper method
function streamToString(stream) {
    const chunks = [];
    return new Promise((resolve, reject) => {
        stream.on('data', (chunk) => chunks.push(Buffer.from(chunk)));
        stream.on('error', (err) => reject(err));
        stream.on('end', () => resolve(Buffer.concat(chunks).toString('utf8')));
    });
}
//function fetches the validation summary stored in S3 bucket through execution of template tasks in validation mode
async function getValidationErrorsFromS3(response, bucketPrefix) {
    const data = await Promise.all(response.map(async (content) => {
        if (content.Key !== bucketPrefix) {
            let validationErrors = "";
            let params;
            params = {
                Bucket: process.env.CUSTOMER_REPO_BUCKET,
                Key: content.Key
            };
            cchLambdaLogger.log("content.Key: ", content.Key);
            var outputResponse = await s3Client.send(new GetObjectCommand(params));
            const bodyContents = await streamToString(outputResponse.Body);
            var executionName = JSON.parse(bodyContents).ExecutionName;
            var executionErrors = JSON.parse(bodyContents).Errors;
            validationErrors = `---Execution Name: ${JSON.stringify(executionName)}---  `;
            validationErrors = validationErrors + `Validation Errors: \n${JSON.stringify(executionErrors)}`;
            validationErrors = `${JSON.stringify(validationErrors)}---`;
            validationErrors = validationErrors.replace(/\\/g, "");
            return validationErrors;
        }
    }));
    cchLambdaLogger.log("Data returned from S3: ", data);
    return data;
}
//function sets the bucket parameters to make a call to S3 bucket where the validation summary for template tasks is stored
//and also gets a list of objects from the same S3 bucket
async function getValidationErrors(bucketPrefix) {
    let truncated = true;
    let validationErrors = "";
    // Create the parameters for calling listObjects
    var bucketParams = {
        Bucket: process.env.CUSTOMER_REPO_BUCKET,
        Delimiter: '/',
        Prefix: bucketPrefix
    };
    cchLambdaLogger.log("S3 bucket call params: ", bucketParams);
    // Call S3 to obtain a list of the objects in the bucket
    while (truncated) {
        try {
            const response = await s3Client.send(new ListObjectsCommand(bucketParams));
            validationErrors = await getValidationErrorsFromS3(response.Contents, bucketPrefix);
            truncated = response.IsTruncated;
        }
        catch (err) {
            console.log("Error", err);
            truncated = false;
        }
    }
    return validationErrors;
}
var cchLambdaLogger;
const handler = async (event, context) => {
    var _a, _b;
    cchLambdaLogger = new cchLambdaLogger_1.CCHLambdaLogger(process.env.STAGE_PREFIX, process.env.REGION, process.env.ACCOUNT, process.env.CCH_VERSION, context, process.env.KINESIS_ENABLED, event.input.customer.customerPrefix, event.input.customer.zone, '', '', event.input.custom.FCCH.FCCH_Execution, event.input.custom.FCCH.FCCH_Input['producer-id']);
    cchLambdaLogger.log("logValidationSummary Lambda Started", event);
    let validationErrors = "";
    let cchExecutionId;
    let bucketPrefix;
    try {
        cchExecutionId = (_b = (_a = event.input.custom) === null || _a === void 0 ? void 0 : _a.FCCH) === null || _b === void 0 ? void 0 : _b.FCCH_Execution.split(/[:]+/).pop();
        bucketPrefix = `cch-tor-executions/${cchExecutionId}/`;
        validationErrors = await getValidationErrors(bucketPrefix);
        if (validationErrors === "") {
            validationErrors = "No Validation Errors Found.";
        }
        cchLambdaLogger.log("Validation Errors Summary: ", validationErrors);
    }
    catch (err) {
        cchLambdaLogger.error(err);
        throw err;
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nVmFsaWRhdGlvblN1bW1hcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9sYW1iZGEvbG9nVmFsaWRhdGlvblN1bW1hcnkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsTUFBTSxFQUNGLFFBQVEsRUFDUixnQkFBZ0IsRUFDaEIsa0JBQWtCLEVBQ25CLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFcEMsdURBQW9EO0FBRXBELE1BQU0sUUFBUSxHQUFHLElBQUksUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUU5RCwrQkFBK0I7QUFDL0IsU0FBUyxjQUFjLENBQUMsTUFBTTtJQUMxQixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFDbEIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNyQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5RCxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMxRSxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFFSCxvSEFBb0g7QUFDcEgsS0FBSyxVQUFVLHlCQUF5QixDQUFDLFFBQVEsRUFBRSxZQUFZO0lBQzNELE1BQU0sSUFB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QUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sR0FBRyxDQUFDO0tBQ2I7QUFFTCxDQUFDLENBQUE7QUF2QlksUUFBQSxPQUFPLFdBdUJuQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHtcbiAgICBTM0NsaWVudCxcbiAgICBHZXRPYmplY3RDb21tYW5kLFxuICAgIExpc3RPYmplY3RzQ29tbWFuZFxuICB9ID0gcmVxdWlyZShcIkBhd3Mtc2RrL2NsaWVudC1zM1wiKTtcbiAgXG5pbXBvcnQgeyBDQ0hMYW1iZGFMb2dnZXIgfSBmcm9tIFwiLi9jY2hMYW1iZGFMb2dnZXJcIjtcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LlJFR0lPTiB9KTtcblxuLy8gRmlsZSB0byBzdHJpbmcgaGVscGVyIG1ldGhvZFxuZnVuY3Rpb24gc3RyZWFtVG9TdHJpbmcoc3RyZWFtKSB7XG4gICAgY29uc3QgY2h1bmtzID0gW107XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHN0cmVhbS5vbignZGF0YScsIChjaHVuaykgPT4gY2h1bmtzLnB1c2goQnVmZmVyLmZyb20oY2h1bmspKSk7XG4gICAgICBzdHJlYW0ub24oJ2Vycm9yJywgKGVycikgPT4gcmVqZWN0KGVycikpO1xuICAgICAgc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKEJ1ZmZlci5jb25jYXQoY2h1bmtzKS50b1N0cmluZygndXRmOCcpKSk7XG4gICAgfSlcbiAgfVxuXG4vL2Z1bmN0aW9uIGZldGNoZXMgdGhlIHZhbGlkYXRpb24gc3VtbWFyeSBzdG9yZWQgaW4gUzMgYnVja2V0IHRocm91Z2ggZXhlY3V0aW9uIG9mIHRlbXBsYXRlIHRhc2tzIGluIHZhbGlkYXRpb24gbW9kZVxuYXN5bmMgZnVuY3Rpb24gZ2V0VmFsaWRhdGlvbkVycm9yc0Zyb21TMyhyZXNwb25zZSwgYnVja2V0UHJlZml4KXtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgUHJvbWlzZS5hbGwocmVzcG9uc2UubWFwKGFzeW5jIChjb250ZW50KSA9PiB7XG4gICAgICBpZiAoY29udGVudC5LZXkgIT09IGJ1Y2tldFByZWZpeCkge1xuICAgICAgICBsZXQgdmFsaWRhdGlvbkVycm9ycyA9IFwiXCI7IFxuICAgICAgICBsZXQgcGFyYW1zO1xuICAgICAgICBwYXJhbXMgPSB7XG4gICAgICAgICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkNVU1RPTUVSX1JFUE9fQlVDS0VULFxuICAgICAgICAgICAgS2V5OiBjb250ZW50LktleVxuICAgICAgICAgIH07IFxuICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJjb250ZW50LktleTogXCIsIGNvbnRlbnQuS2V5KTtcbiAgICAgICAgICB2YXIgb3V0cHV0UmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKG5ldyBHZXRPYmplY3RDb21tYW5kKHBhcmFtcykpO1xuICAgICAgICAgIGNvbnN0IGJvZHlDb250ZW50cyA9IGF3YWl0IHN0cmVhbVRvU3RyaW5nKG91dHB1dFJlc3BvbnNlLkJvZHkpO1xuICAgICAgICAgIHZhciBleGVjdXRpb25OYW1lID0gSlNPTi5wYXJzZShib2R5Q29udGVudHMpLkV4ZWN1dGlvbk5hbWU7XG4gICAgICAgICAgdmFyIGV4ZWN1dGlvbkVycm9ycyAgPSBKU09OLnBhcnNlKGJvZHlDb250ZW50cykuRXJyb3JzO1xuICAgICAgICAgIFxuICAgICAgICAgIHZhbGlkYXRpb25FcnJvcnMgPSBgLS0tRXhlY3V0aW9uIE5hbWU6ICR7SlNPTi5zdHJpbmdpZnkoZXhlY3V0aW9uTmFtZSl9LS0tICBgO1xuICAgICAgICAgIHZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0aW9uRXJyb3JzICsgYFZhbGlkYXRpb24gRXJyb3JzOiBcXG4ke0pTT04uc3RyaW5naWZ5KGV4ZWN1dGlvbkVycm9ycyl9YDtcbiAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JzID0gYCR7SlNPTi5zdHJpbmdpZnkodmFsaWRhdGlvbkVycm9ycyl9LS0tYDtcbiAgICAgICAgICB2YWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGlvbkVycm9ycy5yZXBsYWNlKC9cXFxcL2csIFwiXCIpO1xuXG4gICAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25FcnJvcnM7XG4gICAgICB9XG4gICAgfSkpO1xuICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJEYXRhIHJldHVybmVkIGZyb20gUzM6IFwiICwgZGF0YSk7XG4gICAgcmV0dXJuIGRhdGE7XG59XG5cbi8vZnVuY3Rpb24gc2V0cyB0aGUgYnVja2V0IHBhcmFtZXRlcnMgdG8gbWFrZSBhIGNhbGwgdG8gUzMgYnVja2V0IHdoZXJlIHRoZSB2YWxpZGF0aW9uIHN1bW1hcnkgZm9yIHRlbXBsYXRlIHRhc2tzIGlzIHN0b3JlZFxuLy9hbmQgYWxzbyBnZXRzIGEgbGlzdCBvZiBvYmplY3RzIGZyb20gdGhlIHNhbWUgUzMgYnVja2V0XG5hc3luYyBmdW5jdGlvbiBnZXRWYWxpZGF0aW9uRXJyb3JzKGJ1Y2tldFByZWZpeCkge1xuICBsZXQgdHJ1bmNhdGVkID0gdHJ1ZTtcbiAgbGV0IHZhbGlkYXRpb25FcnJvcnMgPSBcIlwiO1xuICAgIC8vIENyZWF0ZSB0aGUgcGFyYW1ldGVycyBmb3IgY2FsbGluZyBsaXN0T2JqZWN0c1xuICAgIHZhciBidWNrZXRQYXJhbXMgPSB7XG4gICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkNVU1RPTUVSX1JFUE9fQlVDS0VULFxuICAgICAgRGVsaW1pdGVyOiAnLycsXG4gICAgICBQcmVmaXg6IGJ1Y2tldFByZWZpeFxuICB9O1xuICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiUzMgYnVja2V0IGNhbGwgcGFyYW1zOiBcIiAsIGJ1Y2tldFBhcmFtcyk7XG4gIC8vIENhbGwgUzMgdG8gb2J0YWluIGEgbGlzdCBvZiB0aGUgb2JqZWN0cyBpbiB0aGUgYnVja2V0XG4gIHdoaWxlICh0cnVuY2F0ZWQpIHtcbiAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgczNDbGllbnQuc2VuZChuZXcgTGlzdE9iamVjdHNDb21tYW5kKGJ1Y2tldFBhcmFtcykpO1xuICAgICAgICAgIHZhbGlkYXRpb25FcnJvcnMgPSBhd2FpdCBnZXRWYWxpZGF0aW9uRXJyb3JzRnJvbVMzKHJlc3BvbnNlLkNvbnRlbnRzLCBidWNrZXRQcmVmaXgpO1xuICAgICAgICAgIHRydW5jYXRlZCA9IHJlc3BvbnNlLklzVHJ1bmNhdGVkO1xuICAgIH1jYXRjaCAoZXJyKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXCJFcnJvclwiLCBlcnIpO1xuICAgICAgICAgIHRydW5jYXRlZCA9IGZhbHNlO1xuICAgIH1cbiAgfSBcbiAgIHJldHVybiB2YWxpZGF0aW9uRXJyb3JzO1xufVxuXG5cbnZhciBjY2hMYW1iZGFMb2dnZXI7XG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jKGV2ZW50LCBjb250ZXh0KSA9PiB7XG4gICAgY2NoTGFtYmRhTG9nZ2VyID0gbmV3IENDSExhbWJkYUxvZ2dlcihwcm9jZXNzLmVudi5TVEFHRV9QUkVGSVgsIHByb2Nlc3MuZW52LlJFR0lPTiwgcHJvY2Vzcy5lbnYuQUNDT1VOVCwgXG4gICAgICAgIHByb2Nlc3MuZW52LkNDSF9WRVJTSU9OLCBjb250ZXh0LCBwcm9jZXNzLmVudi5LSU5FU0lTX0VOQUJMRUQsIGV2ZW50LmlucHV0LmN1c3RvbWVyLmN1c3RvbWVyUHJlZml4LCBcbiAgICAgICAgZXZlbnQuaW5wdXQuY3VzdG9tZXIuem9uZSwgJycsICcnLCBldmVudC5pbnB1dC5jdXN0b20uRkNDSC5GQ0NIX0V4ZWN1dGlvbiwgZXZlbnQuaW5wdXQuY3VzdG9tLkZDQ0guRkNDSF9JbnB1dFsncHJvZHVjZXItaWQnXSk7XG5cbiAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwibG9nVmFsaWRhdGlvblN1bW1hcnkgTGFtYmRhIFN0YXJ0ZWRcIiwgZXZlbnQpO1xuICAgIGxldCB2YWxpZGF0aW9uRXJyb3JzID0gXCJcIjtcbiAgICBsZXQgY2NoRXhlY3V0aW9uSWQ7XG4gICAgbGV0IGJ1Y2tldFByZWZpeDtcblxuICAgIHRyeXtcbiAgICAgICAgY2NoRXhlY3V0aW9uSWQgPSBldmVudC5pbnB1dC5jdXN0b20/LkZDQ0g/LkZDQ0hfRXhlY3V0aW9uLnNwbGl0KC9bOl0rLykucG9wKCk7XG4gICAgICAgIGJ1Y2tldFByZWZpeCA9IGBjY2gtdG9yLWV4ZWN1dGlvbnMvJHtjY2hFeGVjdXRpb25JZH0vYDtcbiAgICAgICAgdmFsaWRhdGlvbkVycm9ycyA9IGF3YWl0IGdldFZhbGlkYXRpb25FcnJvcnMoYnVja2V0UHJlZml4KTtcbiAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvcnMgPT09IFwiXCIpe1xuICAgICAgICAgIHZhbGlkYXRpb25FcnJvcnMgPSBcIk5vIFZhbGlkYXRpb24gRXJyb3JzIEZvdW5kLlwiO1xuICAgICAgICB9XG4gICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJWYWxpZGF0aW9uIEVycm9ycyBTdW1tYXJ5OiBcIiAsIHZhbGlkYXRpb25FcnJvcnMpO1xuICAgIH1jYXRjaChlcnIpe1xuICAgICAgICBjY2hMYW1iZGFMb2dnZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgIH1cblxufSJdfQ==