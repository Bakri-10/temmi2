"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require('aws-sdk');
const path = require('path');
const cchLambdaLogger_js_1 = require("./cchLambdaLogger.js");
const CCHErrors_js_1 = require("./CCHErrors.js");
const s3 = new AWS.S3();
var cchLambdaLogger;
function getEnvPrefix(customerDefinition) {
    return customerDefinition.envPrefix.S;
}
function padTo2Digits(num) {
    return num.toString().padStart(2, '0');
}
function getformattedDate() {
    let dateTimeNow = new Date();
    let formattedDate = padTo2Digits(dateTimeNow.getDate())
        + '' + padTo2Digits((dateTimeNow.getMonth()) + 1)
        + '-' + padTo2Digits(dateTimeNow.getHours())
        + padTo2Digits(dateTimeNow.getMinutes())
        + padTo2Digits(dateTimeNow.getSeconds());
    return formattedDate;
}
function formatNoOpExecutionName(event, executionEnvPrefix, suffix) {
    cchLambdaLogger.log("Inside formatNoOpExecutionName: ");
    var executionDateTime = getformattedDate();
    var fileName = path.parse(event.template.file).name;
    var executionName = `${event.input.customer.customerPrefix}-${executionEnvPrefix}-${executionDateTime}-${fileName}-${suffix}`;
    if (executionName.length > 80) {
        executionName = executionName.slice(0, 80);
    }
    return executionName;
}
exports.handler = async (event, context) => {
    var _a, _b;
    cchLambdaLogger = new cchLambdaLogger_js_1.CCHLambdaLogger(process.env.STAGE_PREFIX, process.env.REGION, process.env.ACCOUNT, process.env.CCH_VERSION, context, process.env.KINESIS_ENABLED, event.input.customer.customerPrefix, event.input.customer.zone, '', '', event.input.custom.FCCH.FCCH_Execution, event.input.custom.FCCH.FCCH_Input['producer-id']);
    cchLambdaLogger.log("Inside readS3 lambda", event);
    const s3key = event.template.folder + '/' + event.template.file;
    cchLambdaLogger.log("s3key", s3key);
    const bucketParams = {
        Bucket: event.template.bucket,
        Key: s3key
    };
    let errorMsg;
    try {
        errorMsg = `Couldn't read ${s3key} from ${event.template.bucket}`;
        const data = await s3.getObject(bucketParams).promise();
        const output = data.Body.toString();
        let myjson = JSON.parse(output);
        let templateParams;
        let tofParams;
        let myJsonParams;
        let appName;
        let appVersion;
        let executionDateTime;
        let executionEnvPrefix;
        let executionName = "";
        let skippedTasks = [];
        let tempObj = [];
        let taskCheckMap = new Map();
        let stageCheckMap = new Map();
        let envList = [];
        let inputEnvList = (_a = event.input.custom.FCCH.FCCH_Input) === null || _a === void 0 ? void 0 : _a.envList; //Stores envList passed as an input to CCH.
        let stageLength = myjson.stages.length;
        //get db config data.
        const customerConfig = event.config.customer.Item.config.M;
        const validationMode = event.input.validationMode;
        const sendDeploymentReportMode = event.input.cchReportRequired;
        const params = JSON.parse(JSON.stringify(event.input));
        cchLambdaLogger.log("event.input.validationMode", validationMode);
        cchLambdaLogger.log("event.input.cchReportRequired", sendDeploymentReportMode);
        // Validate stages and tasks lists - cannot use both
        const stages = typeof params.custom.FCCH.FCCH_Input.stages !== 'undefined' ? params.custom.FCCH.FCCH_Input.stages : [];
        const tasks = typeof params.custom.FCCH.FCCH_Input.tasks !== 'undefined' ? params.custom.FCCH.FCCH_Input.tasks : [];
        cchLambdaLogger.log("stages", JSON.stringify(stages));
        cchLambdaLogger.log("tasks", JSON.stringify(tasks));
        if (stages.length > 0 && tasks.length > 0) {
            errorMsg = "tasks and stages parameters both specified in payload, these are mutually exclusive options.";
            throw (errorMsg);
        }
        // Create map to track that task filter list items are present and enabled
        if (tasks.length > 0) {
            for (let thisTask = 0; thisTask < tasks.length; thisTask++) {
                taskCheckMap.set(tasks[thisTask], false);
            }
        }
        // Create map to track that stage filter list items are present
        if (stages.length > 0) {
            for (let thisStage = 0; thisStage < stages.length; thisStage++) {
                stageCheckMap.set(stages[thisStage], false);
            }
        }
        for (let i = 0; i < stageLength; i++) {
            let taskLength = myjson.stages[i].tasks.length;
            // Check off that this stage is valid
            stageCheckMap.set(myjson.stages[i].stage, true);
            // Skip this stage by disabling its tasks if stage is NOT on the STAGES filter list
            if (stages.length > 0 && !stages.includes(myjson.stages[i].stage)) {
                cchLambdaLogger.log("Skipping stage", myjson.stages[i].stage);
                for (let thisTask = 0; thisTask < taskLength; thisTask++) {
                    cchLambdaLogger.log("Disabling task", myjson.stages[i].tasks[thisTask].taskname);
                    myjson.stages[i].tasks[thisTask].enabled = false;
                }
            }
            for (let j = 0; j < taskLength; j++) {
                //condition to skip tasks with enabled flag set to false,
                //and no-op tasks when validationMode is true as no-op tasks wait for manual approval in TOF and it requires no stopping while running CCH in validation mode
                if (myjson.stages[i].tasks[j].enabled !== false
                    && !(((myjson.stages[i].tasks[j]['params']['command']).toLowerCase()) === 'no-op' && params.validationMode === true)) {
                    cchLambdaLogger.log(`Stage index: ${i}, task index ${j}`);
                    templateParams = myjson.stages[i].tasks[j]['params'];
                    cchLambdaLogger.log("TemplateParams", templateParams);
                    cchLambdaLogger.log("Params", params);
                    // Add this task to skippedTasks if it is NOT on the TASKS filter list
                    if (tasks.length > 0 && !tasks.includes(myjson.stages[i].tasks[j].taskname)) {
                        cchLambdaLogger.log("Skipping task", myjson.stages[i].tasks[j].taskname);
                        tempObj = [i, j];
                        skippedTasks.push(tempObj);
                    }
                    else {
                        cchLambdaLogger.log(`Stage index: ${i}, task index ${j}`, myjson.stages[i].tasks[j].taskname);
                        templateParams = myjson.stages[i].tasks[j]['params'];
                        cchLambdaLogger.log("TemplateParams", templateParams);
                        cchLambdaLogger.log("Params", params);
                        cchLambdaLogger.log("Merging any task and CCH custom inputs");
                        let custom = { ...params['custom'], ...templateParams['custom'] };
                        params['custom'] = custom;
                        tofParams = { ...templateParams, ...params };
                        if (!(templateParams['custom'] && templateParams['custom']['emailContent'])) {
                            //Remove emailContent block retained from previous objects
                            delete tofParams['custom'].emailContent;
                        }
                        cchLambdaLogger.log("Final TOF input is", tofParams);
                        myjson.stages[i].tasks[j]['params'] = tofParams;
                        //Set manualApproval to true for no-op tasks
                        if (((myjson.stages[i].tasks[j]['params']['command']).toLowerCase()) == 'no-op') {
                            myjson.stages[i].tasks[j]['params'].manualApprovalRequired = true;
                        }
                        myJsonParams = myjson.stages[i].tasks[j]['params'];
                        //Getting app name and version from params
                        appName = myJsonParams.app;
                        appVersion = myJsonParams.version;
                        //Getting execution date-time
                        executionDateTime = getformattedDate();
                        //Getting envPrefix and envList value
                        // Determine the execution environment prefix
                        let executionEnvPrefix = (myJsonParams.envList && myJsonParams.envList.length > 0)
                            ? "${envPrefix}" // Placeholder for replacement in parallel map
                            : ((_b = myJsonParams.envPrefix) !== null && _b !== void 0 ? _b : getEnvPrefix(customerConfig));
                        // Set the list of environments to iterate over
                        envList = (myJsonParams.envList && myJsonParams.envList.length > 0)
                            ? [...myJsonParams.envList]
                            : [executionEnvPrefix];
                        // Generate execution name
                        if (appName && appVersion) {
                            executionName = `s${i + 1}t${j + 1}-${myJsonParams.customer.customerPrefix}-${executionEnvPrefix}-${executionDateTime}-${myJsonParams.command}-${appName}-${appVersion}`;
                        }
                        else {
                            executionName = `s${i + 1}t${j + 1}-${myJsonParams.customer.customerPrefix}-${executionEnvPrefix}-${executionDateTime}-${myJsonParams.command}`;
                        }
                        if (executionName.length > 80) {
                            executionName = executionName.slice(0, 80);
                        }
                        cchLambdaLogger.log("TOF execution name: ", executionName);
                        myjson.stages[i].tasks[j]['params'].executionName = executionName;
                        // Set task map entry to true
                        taskCheckMap.set(myjson.stages[i].tasks[j].taskname, true);
                    }
                }
                else if (myjson.stages[i].tasks[j].enabled === false || (((myjson.stages[i].tasks[j]['params']['command']).toLowerCase()) === 'no-op' && params.validationMode === true)) {
                    tempObj = [i, j];
                    skippedTasks.push(tempObj);
                }
            }
        }
        // Remove disabled tasks from TOF payload & no-op tasks when validation mode is true
        skippedTasks.reverse();
        skippedTasks.forEach(function (myObj) {
            myjson.stages[myObj[0]].tasks.splice(myObj[1], 1);
        });
        //Set execution names for no-ops
        if (validationMode) {
            executionName = formatNoOpExecutionName(event, executionEnvPrefix, 'validation-report');
            myjson = { ...myjson, "NoOpExecutionName": executionName };
        }
        else if (sendDeploymentReportMode) {
            executionName = formatNoOpExecutionName(event, executionEnvPrefix, 'deployment-report');
            myjson = { ...myjson, "NoOpExecutionName": executionName };
        }
        // Set execution name for package customer task
        let fileName = path.parse(event.template.file).name;
        executionDateTime = getformattedDate();
        executionName = `${event.input.customer.customerPrefix}-${event.input.customer.zone}-${executionDateTime}-${fileName}-package-customer-only`;
        if (executionName.length > 80) {
            executionName = executionName.slice(0, 80);
        }
        myjson = { ...myjson, "PackageExecutionName": executionName };
        //This will set envList to the returned object.
        myjson = { ...myjson, "envList": envList };
        cchLambdaLogger.log("final json- ", myjson);
        // Throw error if requested tasks or stages do not exist in template or are disabled
        // This will be anything which is still "false" in the relevant CheckMap
        let missingTasks = [];
        let missingStages = [];
        cchLambdaLogger.log("taskCheckMap ", ...taskCheckMap);
        for (const [key, value] of taskCheckMap) {
            if (value === false) {
                missingTasks.push(key);
            }
        }
        for (const [key, value] of stageCheckMap) {
            if (value === false) {
                missingStages.push(key);
            }
        }
        if (missingTasks.length > 0) {
            errorMsg = "Requested task(s) missing or disabled " + JSON.stringify(missingTasks);
            throw (errorMsg);
        }
        if (missingStages.length > 0) {
            errorMsg = "Requested Stage(s) missing " + JSON.stringify(missingStages);
            throw (errorMsg);
        }
        return myjson;
    }
    catch (_c) {
        cchLambdaLogger.error(errorMsg);
        throw new CCHErrors_js_1.TemplateValidationError(errorMsg);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZFMzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGFtYmRhL3JlYWRTMy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsNkRBQXVEO0FBQ3ZELGlEQUF5RDtBQUV6RCxNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUV4QixJQUFJLGVBQWUsQ0FBQztBQUVwQixTQUFTLFlBQVksQ0FBQyxrQkFBa0I7SUFDcEMsT0FBTyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzFDLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxHQUFHO0lBQ3JCLE9BQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUVELFNBQVMsZ0JBQWdCO0lBQ2pCLElBQUksV0FBVyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDN0IsSUFBSSxhQUFhLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztVQUNqQyxFQUFFLEdBQUcsWUFBWSxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLEdBQUMsQ0FBQyxDQUFDO1VBQzdDLEdBQUcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDO1VBQzFDLFlBQVksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7VUFDdEMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQzdELE9BQU8sYUFBYSxDQUFDO0FBQzdCLENBQUM7QUFFRCxTQUFTLHVCQUF1QixDQUFDLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxNQUFNO0lBQzlELGVB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QztTQUNuQjtRQUVELE9BQU8sTUFBTSxDQUFDO0tBQ2pCO0lBQ0QsV0FBTTtRQUNGLGVBQWUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEMsTUFBTSxJQUFJLHNDQUF1QixDQUFDLFFBQVEsQ0FBQyxDQUFDO0tBQy9DO0FBQ0wsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmltcG9ydCB7IENDSExhbWJkYUxvZ2dlciB9IGZyb20gXCIuL2NjaExhbWJkYUxvZ2dlci5qc1wiO1xuaW1wb3J0IHsgVGVtcGxhdGVWYWxpZGF0aW9uRXJyb3IgfSBmcm9tIFwiLi9DQ0hFcnJvcnMuanNcIjtcblxuY29uc3QgczMgPSBuZXcgQVdTLlMzKCk7XG5cbnZhciBjY2hMYW1iZGFMb2dnZXI7XG5cbmZ1bmN0aW9uIGdldEVudlByZWZpeChjdXN0b21lckRlZmluaXRpb24pIHsgXG4gICAgcmV0dXJuIGN1c3RvbWVyRGVmaW5pdGlvbi5lbnZQcmVmaXguUztcbn1cblxuZnVuY3Rpb24gcGFkVG8yRGlnaXRzKG51bSkge1xuICAgIHJldHVybiBudW0udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xufSAgIFxuXG5mdW5jdGlvbiBnZXRmb3JtYXR0ZWREYXRlKCl7XG4gICAgICAgIGxldCBkYXRlVGltZU5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBmb3JtYXR0ZWREYXRlID0gcGFkVG8yRGlnaXRzKGRhdGVUaW1lTm93LmdldERhdGUoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArICcnICsgcGFkVG8yRGlnaXRzKChkYXRlVGltZU5vdy5nZXRNb250aCgpKSsxKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJy0nICsgcGFkVG8yRGlnaXRzKGRhdGVUaW1lTm93LmdldEhvdXJzKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBwYWRUbzJEaWdpdHMoZGF0ZVRpbWVOb3cuZ2V0TWludXRlcygpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgcGFkVG8yRGlnaXRzKGRhdGVUaW1lTm93LmdldFNlY29uZHMoKSk7XG4gICAgICAgIHJldHVybiBmb3JtYXR0ZWREYXRlO1xufSAgIFxuXG5mdW5jdGlvbiBmb3JtYXROb09wRXhlY3V0aW9uTmFtZShldmVudCwgZXhlY3V0aW9uRW52UHJlZml4LCBzdWZmaXgpe1xuICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJJbnNpZGUgZm9ybWF0Tm9PcEV4ZWN1dGlvbk5hbWU6IFwiKTtcbiAgICB2YXIgZXhlY3V0aW9uRGF0ZVRpbWUgPSBnZXRmb3JtYXR0ZWREYXRlKCk7XG4gICAgdmFyIGZpbGVOYW1lID0gcGF0aC5wYXJzZShldmVudC50ZW1wbGF0ZS5maWxlKS5uYW1lO1xuICAgIHZhciBleGVjdXRpb25OYW1lID0gYCR7ZXZlbnQuaW5wdXQuY3VzdG9tZXIuY3VzdG9tZXJQcmVmaXh9LSR7ZXhlY3V0aW9uRW52UHJlZml4fS0ke2V4ZWN1dGlvbkRhdGVUaW1lfS0ke2ZpbGVOYW1lfS0ke3N1ZmZpeH1gO1xuICAgIGlmKGV4ZWN1dGlvbk5hbWUubGVuZ3RoID4gODApe1xuICAgICAgICBleGVjdXRpb25OYW1lID0gZXhlY3V0aW9uTmFtZS5zbGljZSgwLDgwKTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGV4ZWN1dGlvbk5hbWU7XG59XG5cbmV4cG9ydHMuaGFuZGxlciA9IGFzeW5jIChldmVudCxjb250ZXh0KSA9PiB7XG5cbiAgICBjY2hMYW1iZGFMb2dnZXIgPSBuZXcgQ0NITGFtYmRhTG9nZ2VyKHByb2Nlc3MuZW52LlNUQUdFX1BSRUZJWCwgcHJvY2Vzcy5lbnYuUkVHSU9OLCBwcm9jZXNzLmVudi5BQ0NPVU5ULCBcbiAgICAgICAgcHJvY2Vzcy5lbnYuQ0NIX1ZFUlNJT04sIGNvbnRleHQsIHByb2Nlc3MuZW52LktJTkVTSVNfRU5BQkxFRCwgZXZlbnQuaW5wdXQuY3VzdG9tZXIuY3VzdG9tZXJQcmVmaXgsIFxuICAgICAgICBldmVudC5pbnB1dC5jdXN0b21lci56b25lLCAnJywgJycsIGV2ZW50LmlucHV0LmN1c3RvbS5GQ0NILkZDQ0hfRXhlY3V0aW9uLCBldmVudC5pbnB1dC5jdXN0b20uRkNDSC5GQ0NIX0lucHV0Wydwcm9kdWNlci1pZCddKTtcbiAgICBcbiAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiSW5zaWRlIHJlYWRTMyBsYW1iZGFcIiwgZXZlbnQpO1xuXG4gICAgY29uc3QgczNrZXkgPSBldmVudC50ZW1wbGF0ZS5mb2xkZXIgKyAnLycgKyBldmVudC50ZW1wbGF0ZS5maWxlO1xuICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJzM2tleVwiLCBzM2tleSk7XG4gICAgY29uc3QgYnVja2V0UGFyYW1zID0ge1xuICAgICAgICBCdWNrZXQgOiBldmVudC50ZW1wbGF0ZS5idWNrZXQsXG4gICAgICAgIEtleTogczNrZXlcbiAgICB9O1xuICAgIGxldCBlcnJvck1zZztcbiAgICB0cnkge1xuICAgICAgICBlcnJvck1zZyA9IGBDb3VsZG4ndCByZWFkICR7czNrZXl9IGZyb20gJHtldmVudC50ZW1wbGF0ZS5idWNrZXR9YDtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHMzLmdldE9iamVjdChidWNrZXRQYXJhbXMpLnByb21pc2UoKTsgXG5cbiAgICAgICAgY29uc3Qgb3V0cHV0ID0gZGF0YS5Cb2R5LnRvU3RyaW5nKCk7XG4gICAgICAgIFxuICAgICAgICBsZXQgbXlqc29uID0gSlNPTi5wYXJzZShvdXRwdXQpO1xuICAgICAgICBsZXQgdGVtcGxhdGVQYXJhbXM7XG4gICAgICAgIGxldCB0b2ZQYXJhbXM7XG4gICAgICAgIGxldCBteUpzb25QYXJhbXM7XG4gICAgICAgIGxldCBhcHBOYW1lO1xuICAgICAgICBsZXQgYXBwVmVyc2lvbjtcbiAgICAgICAgbGV0IGV4ZWN1dGlvbkRhdGVUaW1lOyAgICAgICBcbiAgICAgICAgbGV0IGV4ZWN1dGlvbkVudlByZWZpeDtcbiAgICAgICAgbGV0IGV4ZWN1dGlvbk5hbWU9XCJcIjtcbiAgICAgICAgbGV0IHNraXBwZWRUYXNrcyA9IFtdO1xuICAgICAgICBsZXQgdGVtcE9iaiA9IFtdO1xuICAgICAgICBsZXQgdGFza0NoZWNrTWFwID0gbmV3IE1hcCgpO1xuICAgICAgICBsZXQgc3RhZ2VDaGVja01hcCA9IG5ldyBNYXAoKTtcbiAgICAgICAgbGV0IGVudkxpc3QgPSBbXTtcbiAgICAgICAgbGV0IGlucHV0RW52TGlzdCA9IGV2ZW50LmlucHV0LmN1c3RvbS5GQ0NILkZDQ0hfSW5wdXQ/LmVudkxpc3Q7IC8vU3RvcmVzIGVudkxpc3QgcGFzc2VkIGFzIGFuIGlucHV0IHRvIENDSC5cbiAgICAgICAgXG4gICAgICAgIGxldCBzdGFnZUxlbmd0aCA9IG15anNvbi5zdGFnZXMubGVuZ3RoO1xuXG4gICAgICAgIC8vZ2V0IGRiIGNvbmZpZyBkYXRhLlxuICAgICAgICBjb25zdCBjdXN0b21lckNvbmZpZyA9IGV2ZW50LmNvbmZpZy5jdXN0b21lci5JdGVtLmNvbmZpZy5NO1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uTW9kZSA9IGV2ZW50LmlucHV0LnZhbGlkYXRpb25Nb2RlO1xuICAgICAgICBjb25zdCBzZW5kRGVwbG95bWVudFJlcG9ydE1vZGUgPSBldmVudC5pbnB1dC5jY2hSZXBvcnRSZXF1aXJlZDtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudC5pbnB1dCkpO1xuICAgICAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiZXZlbnQuaW5wdXQudmFsaWRhdGlvbk1vZGVcIiwgdmFsaWRhdGlvbk1vZGUpO1xuICAgICAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiZXZlbnQuaW5wdXQuY2NoUmVwb3J0UmVxdWlyZWRcIiwgc2VuZERlcGxveW1lbnRSZXBvcnRNb2RlKTtcblxuICAgICAgICAvLyBWYWxpZGF0ZSBzdGFnZXMgYW5kIHRhc2tzIGxpc3RzIC0gY2Fubm90IHVzZSBib3RoXG4gICAgICAgIGNvbnN0IHN0YWdlcyA9IHR5cGVvZiBwYXJhbXMuY3VzdG9tLkZDQ0guRkNDSF9JbnB1dC5zdGFnZXMgIT09ICd1bmRlZmluZWQnID8gcGFyYW1zLmN1c3RvbS5GQ0NILkZDQ0hfSW5wdXQuc3RhZ2VzIDogW107XG4gICAgICAgIGNvbnN0IHRhc2tzID0gdHlwZW9mIHBhcmFtcy5jdXN0b20uRkNDSC5GQ0NIX0lucHV0LnRhc2tzICE9PSAndW5kZWZpbmVkJyA/IHBhcmFtcy5jdXN0b20uRkNDSC5GQ0NIX0lucHV0LnRhc2tzIDogW107XG5cbiAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhcInN0YWdlc1wiLCBKU09OLnN0cmluZ2lmeShzdGFnZXMpKTtcbiAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhcInRhc2tzXCIsIEpTT04uc3RyaW5naWZ5KHRhc2tzKSk7XG4gICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICBpZiAoc3RhZ2VzLmxlbmd0aCA+IDAgJiYgdGFza3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZXJyb3JNc2cgPVwidGFza3MgYW5kIHN0YWdlcyBwYXJhbWV0ZXJzIGJvdGggc3BlY2lmaWVkIGluIHBheWxvYWQsIHRoZXNlIGFyZSBtdXR1YWxseSBleGNsdXNpdmUgb3B0aW9ucy5cIjtcbiAgICAgICAgICAgIHRocm93KGVycm9yTXNnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBtYXAgdG8gdHJhY2sgdGhhdCB0YXNrIGZpbHRlciBsaXN0IGl0ZW1zIGFyZSBwcmVzZW50IGFuZCBlbmFibGVkXG4gICAgICAgIGlmICh0YXNrcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB0aGlzVGFzayA9IDA7IHRoaXNUYXNrIDwgdGFza3MubGVuZ3RoOyB0aGlzVGFzaysrKSB7XG4gICAgICAgICAgICAgICAgdGFza0NoZWNrTWFwLnNldCh0YXNrc1t0aGlzVGFza10sIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBtYXAgdG8gdHJhY2sgdGhhdCBzdGFnZSBmaWx0ZXIgbGlzdCBpdGVtcyBhcmUgcHJlc2VudFxuICAgICAgICBpZiAoc3RhZ2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvciAobGV0IHRoaXNTdGFnZSA9IDA7IHRoaXNTdGFnZSA8IHN0YWdlcy5sZW5ndGg7IHRoaXNTdGFnZSsrKSB7XG4gICAgICAgICAgICAgICAgc3RhZ2VDaGVja01hcC5zZXQoc3RhZ2VzW3RoaXNTdGFnZV0sIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdGFnZUxlbmd0aDsgaSsrKXtcbiAgICAgICAgICAgIGxldCB0YXNrTGVuZ3RoID0gbXlqc29uLnN0YWdlc1tpXS50YXNrcy5sZW5ndGg7XG4gICAgICAgICAgICAvLyBDaGVjayBvZmYgdGhhdCB0aGlzIHN0YWdlIGlzIHZhbGlkXG4gICAgICAgICAgICBzdGFnZUNoZWNrTWFwLnNldChteWpzb24uc3RhZ2VzW2ldLnN0YWdlLCB0cnVlKTtcblxuICAgICAgICAgICAgLy8gU2tpcCB0aGlzIHN0YWdlIGJ5IGRpc2FibGluZyBpdHMgdGFza3MgaWYgc3RhZ2UgaXMgTk9UIG9uIHRoZSBTVEFHRVMgZmlsdGVyIGxpc3RcbiAgICAgICAgICAgIGlmIChzdGFnZXMubGVuZ3RoID4gMCAmJiAhc3RhZ2VzLmluY2x1ZGVzKG15anNvbi5zdGFnZXNbaV0uc3RhZ2UpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJTa2lwcGluZyBzdGFnZVwiLCBteWpzb24uc3RhZ2VzW2ldLnN0YWdlKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgdGhpc1Rhc2sgPSAwOyB0aGlzVGFzayA8IHRhc2tMZW5ndGg7IHRoaXNUYXNrKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJEaXNhYmxpbmcgdGFza1wiLCBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW3RoaXNUYXNrXS50YXNrbmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW3RoaXNUYXNrXS5lbmFibGVkID0gZmFsc2U7IFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGFza0xlbmd0aDsgaisrKXtcbiAgICAgICAgICAgICAgICAvL2NvbmRpdGlvbiB0byBza2lwIHRhc2tzIHdpdGggZW5hYmxlZCBmbGFnIHNldCB0byBmYWxzZSxcbiAgICAgICAgICAgICAgICAvL2FuZCBuby1vcCB0YXNrcyB3aGVuIHZhbGlkYXRpb25Nb2RlIGlzIHRydWUgYXMgbm8tb3AgdGFza3Mgd2FpdCBmb3IgbWFudWFsIGFwcHJvdmFsIGluIFRPRiBhbmQgaXQgcmVxdWlyZXMgbm8gc3RvcHBpbmcgd2hpbGUgcnVubmluZyBDQ0ggaW4gdmFsaWRhdGlvbiBtb2RlXG4gICAgICAgICAgICAgICAgaWYgKG15anNvbi5zdGFnZXNbaV0udGFza3Nbal0uZW5hYmxlZCAhPT0gZmFsc2UgXG4gICAgICAgICAgICAgICAgICAgICYmICEoKChteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdWydwYXJhbXMnXVsnY29tbWFuZCddKS50b0xvd2VyQ2FzZSgpKSA9PT0gJ25vLW9wJyAmJiBwYXJhbXMudmFsaWRhdGlvbk1vZGUgPT09IHRydWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coYFN0YWdlIGluZGV4OiAke2l9LCB0YXNrIGluZGV4ICR7an1gKTtcbiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVQYXJhbXMgPSBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdWydwYXJhbXMnXTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJUZW1wbGF0ZVBhcmFtc1wiLCB0ZW1wbGF0ZVBhcmFtcyk7XG4gICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJQYXJhbXNcIiwgcGFyYW1zKTsgIFxuXG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCB0aGlzIHRhc2sgdG8gc2tpcHBlZFRhc2tzIGlmIGl0IGlzIE5PVCBvbiB0aGUgVEFTS1MgZmlsdGVyIGxpc3RcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2tzLmxlbmd0aCA+IDAgJiYgIXRhc2tzLmluY2x1ZGVzKG15anNvbi5zdGFnZXNbaV0udGFza3Nbal0udGFza25hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiU2tpcHBpbmcgdGFza1wiLCBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdLnRhc2tuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBPYmogPSBbaSxqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBwZWRUYXNrcy5wdXNoKHRlbXBPYmopO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhgU3RhZ2UgaW5kZXg6ICR7aX0sIHRhc2sgaW5kZXggJHtqfWAsIG15anNvbi5zdGFnZXNbaV0udGFza3Nbal0udGFza25hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVQYXJhbXMgPSBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdWydwYXJhbXMnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhcIlRlbXBsYXRlUGFyYW1zXCIsIHRlbXBsYXRlUGFyYW1zKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJQYXJhbXNcIiwgcGFyYW1zKTsgIFxuXG4gICAgICAgICAgICAgICAgICAgICAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiTWVyZ2luZyBhbnkgdGFzayBhbmQgQ0NIIGN1c3RvbSBpbnB1dHNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgY3VzdG9tID0geyAuLi5wYXJhbXNbJ2N1c3RvbSddLCAuLi50ZW1wbGF0ZVBhcmFtc1snY3VzdG9tJ119O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbJ2N1c3RvbSddID0gY3VzdG9tO1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9mUGFyYW1zID0geyAuLi50ZW1wbGF0ZVBhcmFtcywgLi4ucGFyYW1zfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoISh0ZW1wbGF0ZVBhcmFtc1snY3VzdG9tJ10gJiYgdGVtcGxhdGVQYXJhbXNbJ2N1c3RvbSddWydlbWFpbENvbnRlbnQnXSkpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vUmVtb3ZlIGVtYWlsQ29udGVudCBibG9jayByZXRhaW5lZCBmcm9tIHByZXZpb3VzIG9iamVjdHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgIHRvZlBhcmFtc1snY3VzdG9tJ10uZW1haWxDb250ZW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBjY2hMYW1iZGFMb2dnZXIubG9nKFwiRmluYWwgVE9GIGlucHV0IGlzXCIsIHRvZlBhcmFtcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdWydwYXJhbXMnXSA9IHRvZlBhcmFtcztcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy9TZXQgbWFudWFsQXBwcm92YWwgdG8gdHJ1ZSBmb3Igbm8tb3AgdGFza3NcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoKG15anNvbi5zdGFnZXNbaV0udGFza3Nbal1bJ3BhcmFtcyddWydjb21tYW5kJ10pLnRvTG93ZXJDYXNlKCkpID09ICduby1vcCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBteWpzb24uc3RhZ2VzW2ldLnRhc2tzW2pdWydwYXJhbXMnXS5tYW51YWxBcHByb3ZhbFJlcXVpcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgbXlKc29uUGFyYW1zID0gbXlqc29uLnN0YWdlc1tpXS50YXNrc1tqXVsncGFyYW1zJ107XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vR2V0dGluZyBhcHAgbmFtZSBhbmQgdmVyc2lvbiBmcm9tIHBhcmFtc1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwTmFtZSA9ICBteUpzb25QYXJhbXMuYXBwO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwVmVyc2lvbiA9IG15SnNvblBhcmFtcy52ZXJzaW9uO1x0XHRcdFx0XHQgIFxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvL0dldHRpbmcgZXhlY3V0aW9uIGRhdGUtdGltZVxuICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0aW9uRGF0ZVRpbWUgPSBnZXRmb3JtYXR0ZWREYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vR2V0dGluZyBlbnZQcmVmaXggYW5kIGVudkxpc3QgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERldGVybWluZSB0aGUgZXhlY3V0aW9uIGVudmlyb25tZW50IHByZWZpeFxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGV4ZWN1dGlvbkVudlByZWZpeCA9IChteUpzb25QYXJhbXMuZW52TGlzdCAmJiBteUpzb25QYXJhbXMuZW52TGlzdC5sZW5ndGggPiAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgICA/IFwiJHtlbnZQcmVmaXh9XCIgIC8vIFBsYWNlaG9sZGVyIGZvciByZXBsYWNlbWVudCBpbiBwYXJhbGxlbCBtYXBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgOiAobXlKc29uUGFyYW1zLmVudlByZWZpeCA/PyBnZXRFbnZQcmVmaXgoY3VzdG9tZXJDb25maWcpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbGlzdCBvZiBlbnZpcm9ubWVudHMgdG8gaXRlcmF0ZSBvdmVyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnZMaXN0ID0gKG15SnNvblBhcmFtcy5lbnZMaXN0ICYmIG15SnNvblBhcmFtcy5lbnZMaXN0Lmxlbmd0aCA+IDApXG4gICAgICAgICAgICAgICAgICAgICAgICA/IFsuLi5teUpzb25QYXJhbXMuZW52TGlzdF1cbiAgICAgICAgICAgICAgICAgICAgICAgIDogW2V4ZWN1dGlvbkVudlByZWZpeF07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIGV4ZWN1dGlvbiBuYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwTmFtZSAmJiBhcHBWZXJzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0aW9uTmFtZSA9IGBzJHtpKzF9dCR7aisxfS0ke215SnNvblBhcmFtcy5jdXN0b21lci5jdXN0b21lclByZWZpeH0tJHtleGVjdXRpb25FbnZQcmVmaXh9LSR7ZXhlY3V0aW9uRGF0ZVRpbWV9LSR7bXlKc29uUGFyYW1zLmNvbW1hbmR9LSR7YXBwTmFtZX0tJHthcHBWZXJzaW9ufWA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWN1dGlvbk5hbWUgPSBgcyR7aSsxfXQke2orMX0tJHtteUpzb25QYXJhbXMuY3VzdG9tZXIuY3VzdG9tZXJQcmVmaXh9LSR7ZXhlY3V0aW9uRW52UHJlZml4fS0ke2V4ZWN1dGlvbkRhdGVUaW1lfS0ke215SnNvblBhcmFtcy5jb21tYW5kfWA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZXhlY3V0aW9uTmFtZS5sZW5ndGggPiA4MCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhlY3V0aW9uTmFtZSA9IGV4ZWN1dGlvbk5hbWUuc2xpY2UoMCw4MCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9ICBcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhcIlRPRiBleGVjdXRpb24gbmFtZTogXCIsIGV4ZWN1dGlvbk5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbXlqc29uLnN0YWdlc1tpXS50YXNrc1tqXVsncGFyYW1zJ10uZXhlY3V0aW9uTmFtZSA9IGV4ZWN1dGlvbk5hbWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0YXNrIG1hcCBlbnRyeSB0byB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXNrQ2hlY2tNYXAuc2V0KG15anNvbi5zdGFnZXNbaV0udGFza3Nbal0udGFza25hbWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG15anNvbi5zdGFnZXNbaV0udGFza3Nbal0uZW5hYmxlZCA9PT0gZmFsc2UgfHwgKCgobXlqc29uLnN0YWdlc1tpXS50YXNrc1tqXVsncGFyYW1zJ11bJ2NvbW1hbmQnXSkudG9Mb3dlckNhc2UoKSkgPT09ICduby1vcCcgJiYgcGFyYW1zLnZhbGlkYXRpb25Nb2RlID09PSB0cnVlKSl7XG4gICAgICAgICAgICAgICAgICAgIHRlbXBPYmogPSBbaSxqXTtcbiAgICAgICAgICAgICAgICAgICAgc2tpcHBlZFRhc2tzLnB1c2godGVtcE9iaik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIFJlbW92ZSBkaXNhYmxlZCB0YXNrcyBmcm9tIFRPRiBwYXlsb2FkICYgbm8tb3AgdGFza3Mgd2hlbiB2YWxpZGF0aW9uIG1vZGUgaXMgdHJ1ZVxuICAgICAgICBza2lwcGVkVGFza3MucmV2ZXJzZSgpO1xuICAgICAgICBza2lwcGVkVGFza3MuZm9yRWFjaChmdW5jdGlvbiAobXlPYmopIHtcbiAgICAgICAgICAgIG15anNvbi5zdGFnZXNbbXlPYmpbMF1dLnRhc2tzLnNwbGljZShteU9ialsxXSwgMSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vU2V0IGV4ZWN1dGlvbiBuYW1lcyBmb3Igbm8tb3BzXG4gICAgICAgIGlmKHZhbGlkYXRpb25Nb2RlKSB7XG4gICAgICAgICAgICBleGVjdXRpb25OYW1lID0gZm9ybWF0Tm9PcEV4ZWN1dGlvbk5hbWUoZXZlbnQsIGV4ZWN1dGlvbkVudlByZWZpeCwgJ3ZhbGlkYXRpb24tcmVwb3J0Jyk7XG4gICAgICAgICAgICBteWpzb24gPSB7Li4ubXlqc29uLCBcIk5vT3BFeGVjdXRpb25OYW1lXCIgOiBleGVjdXRpb25OYW1lfTtcbiAgICAgICAgfWVsc2UgaWYoc2VuZERlcGxveW1lbnRSZXBvcnRNb2RlKSB7XG4gICAgICAgICAgICBleGVjdXRpb25OYW1lID0gZm9ybWF0Tm9PcEV4ZWN1dGlvbk5hbWUoZXZlbnQsIGV4ZWN1dGlvbkVudlByZWZpeCwgJ2RlcGxveW1lbnQtcmVwb3J0Jyk7XG4gICAgICAgICAgICBteWpzb24gPSB7Li4ubXlqc29uLCBcIk5vT3BFeGVjdXRpb25OYW1lXCIgOiBleGVjdXRpb25OYW1lfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gU2V0IGV4ZWN1dGlvbiBuYW1lIGZvciBwYWNrYWdlIGN1c3RvbWVyIHRhc2tcbiAgICAgICAgbGV0IGZpbGVOYW1lID0gcGF0aC5wYXJzZShldmVudC50ZW1wbGF0ZS5maWxlKS5uYW1lO1xuICAgICAgICBleGVjdXRpb25EYXRlVGltZSA9IGdldGZvcm1hdHRlZERhdGUoKTtcbiAgICAgICAgZXhlY3V0aW9uTmFtZSA9IGAke2V2ZW50LmlucHV0LmN1c3RvbWVyLmN1c3RvbWVyUHJlZml4fS0ke2V2ZW50LmlucHV0LmN1c3RvbWVyLnpvbmV9LSR7ZXhlY3V0aW9uRGF0ZVRpbWV9LSR7ZmlsZU5hbWV9LXBhY2thZ2UtY3VzdG9tZXItb25seWA7XG4gICAgICAgIGlmKGV4ZWN1dGlvbk5hbWUubGVuZ3RoID4gODApe1xuICAgICAgICAgICAgZXhlY3V0aW9uTmFtZSA9IGV4ZWN1dGlvbk5hbWUuc2xpY2UoMCw4MCk7XG4gICAgICAgIH1cbiAgICAgICAgbXlqc29uID0gey4uLm15anNvbiwgXCJQYWNrYWdlRXhlY3V0aW9uTmFtZVwiIDogZXhlY3V0aW9uTmFtZX07XG4gICAgICAgIC8vVGhpcyB3aWxsIHNldCBlbnZMaXN0IHRvIHRoZSByZXR1cm5lZCBvYmplY3QuXG4gICAgICAgIG15anNvbiA9IHsuLi5teWpzb24sIFwiZW52TGlzdFwiIDogZW52TGlzdH07XG4gICAgICAgIGNjaExhbWJkYUxvZ2dlci5sb2coXCJmaW5hbCBqc29uLSBcIiwgbXlqc29uKTtcbiAgICAgICAgXG5cbiAgICAgICAgLy8gVGhyb3cgZXJyb3IgaWYgcmVxdWVzdGVkIHRhc2tzIG9yIHN0YWdlcyBkbyBub3QgZXhpc3QgaW4gdGVtcGxhdGUgb3IgYXJlIGRpc2FibGVkXG4gICAgICAgIC8vIFRoaXMgd2lsbCBiZSBhbnl0aGluZyB3aGljaCBpcyBzdGlsbCBcImZhbHNlXCIgaW4gdGhlIHJlbGV2YW50IENoZWNrTWFwXG4gICAgICAgIGxldCBtaXNzaW5nVGFza3MgPSBbXTtcbiAgICAgICAgbGV0IG1pc3NpbmdTdGFnZXMgPSBbXTtcbiAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmxvZyhcInRhc2tDaGVja01hcCBcIiwgLi4udGFza0NoZWNrTWFwKTtcblxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0YXNrQ2hlY2tNYXApIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBtaXNzaW5nVGFza3MucHVzaChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHN0YWdlQ2hlY2tNYXApIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBtaXNzaW5nU3RhZ2VzLnB1c2goa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAobWlzc2luZ1Rhc2tzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGVycm9yTXNnID0gXCJSZXF1ZXN0ZWQgdGFzayhzKSBtaXNzaW5nIG9yIGRpc2FibGVkIFwiICsgSlNPTi5zdHJpbmdpZnkobWlzc2luZ1Rhc2tzKTtcbiAgICAgICAgICAgIHRocm93KGVycm9yTXNnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWlzc2luZ1N0YWdlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBlcnJvck1zZyA9IFwiUmVxdWVzdGVkIFN0YWdlKHMpIG1pc3NpbmcgXCIgKyBKU09OLnN0cmluZ2lmeShtaXNzaW5nU3RhZ2VzKTtcbiAgICAgICAgICAgIHRocm93KGVycm9yTXNnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBteWpzb247XG4gICAgfVxuICAgIGNhdGNoIHtcbiAgICAgICAgY2NoTGFtYmRhTG9nZ2VyLmVycm9yKGVycm9yTXNnKTtcbiAgICAgICAgdGhyb3cgbmV3IFRlbXBsYXRlVmFsaWRhdGlvbkVycm9yKGVycm9yTXNnKTtcbiAgICB9XG59Il19