"use strict";
const zlib = require('zlib');
const AWS = require('aws-sdk');
const { get } = require('https');
const cloudwatchlogs = new AWS.CloudWatchLogs({ apiVersion: '2014-03-28' });
var stepfunctions = new AWS.StepFunctions();
function formatAWSServiceURL(logGroupName, logStreamName) {
    const generatedURL = `https://${process.env.REGION}.console.aws.amazon.com/cloudwatch/home?region=${process.env.REGION}#logsV2:log-groups/log-group/` +
        `${logGroupName.replace(/\//ig, "$252F")}` +
        `/log-events/` +
        `${logStreamName.replace(/\//ig, "$252F")}`;
    return generatedURL;
}
function buildMessage(sfLogevent, executionDetails, sfLogDetails, executionLog, subOrderId, subTaskArn, subLogGroupName, subLogStreamName) {
    let stepFunctionInput = JSON.parse(executionDetails.input);
    let parentId = sfLogevent.execution_arn;
    let event_timestamp = sfLogevent.event_timestamp;
    let _executionId = sfLogevent.execution_arn;
    let transactionId;
    if (!stepFunctionInput['producer-id'] ||
        stepFunctionInput['producer-id'] === undefined ||
        stepFunctionInput['producer-id'] === '') {
        transactionId = _executionId;
    }
    else {
        transactionId = stepFunctionInput['producer-id'];
    }
    let eventLogDetail = sfLogevent.details.resourceType ? `(${sfLogevent.details.resourceType})` : "";
    return JSON.stringify({
        "dataType": "INTERNAL",
        "orderId": subOrderId ? "" : sfLogevent.id,
        "spanName": subOrderId ? JSON.parse(sfLogevent.details.output).Build.ProjectName : sfLogevent.execution_arn.split("execution:").pop(),
        "parentId": parentId,
        "sourceDetail": "step function",
        "source": "FCCH",
        "userIdentifier": "fcch-operator",
        "time": parseInt(event_timestamp),
        "transactionId": transactionId,
        "schemaVersion": "1.0.0",
        "zoneType": "INTERNAL",
        "additionalData": {
            "zone": stepFunctionInput.params.customer.zone,
            "accountIdentifier": process.env.ACCOUNT,
            "awsRegion": process.env.REGION,
            "environment": process.env.STAGE,
            "softwareVersion": process.env.CCH_VERSION,
            "log": executionLog == null ? `${sfLogevent.type} ${eventLogDetail}` : executionLog.message,
            "exception": "",
            "awsService": executionLog == null ? "step function" : "codebuild",
            "customer": stepFunctionInput.params.customer.customerPrefix,
            "tofExecutionId": "",
            "fcchExecutionId": _executionId,
            "startTime": event_timestamp,
            "executionContext": "TASK",
            "logGroup": executionLog == null ? sfLogDetails.logGroup : subLogGroupName,
            "logStream": executionLog == null ? sfLogDetails.logStream : subLogStreamName,
            "awsServiceURL": executionLog == null ?
                formatAWSServiceURL(sfLogDetails.logGroup, sfLogDetails.logStream) :
                formatAWSServiceURL(subLogGroupName, subLogStreamName),
            "subOrderId": subOrderId
        }
    });
}
exports.handler = async (event, context) => {
    try {
        if (event.awslogs && event.awslogs.data) {
            const payload = Buffer.from(event.awslogs.data, "base64");
            const logDetails = JSON.parse(zlib.unzipSync(payload).toString());
            const logevents = JSON.parse(zlib.unzipSync(payload).toString()).logEvents;
            let executionARN = JSON.parse(logevents[0].message).execution_arn;
            const executionParams = {
                executionArn: executionARN
            };
            let executionDetails = await stepfunctions.describeExecution(executionParams, function (err, data) {
                if (err)
                    console.log('error : ', err, err.stack); // an error occurred
                else {
                    return data;
                    //console.log('successful response : ', data);           // successful response
                }
            }).promise();
            for (const logevent of logevents) {
                const log = JSON.parse(logevent.message);
                let logGroupName;
                let logStreamName;
                let codebuildArn;
                let getCodeBuildLogs;
                if (log.details.resourceType == 'codebuild' && log.type == "TaskFailed") {
                    logGroupName = JSON.parse(log.details.cause).Build.Logs.GroupName;
                    logStreamName = JSON.parse(log.details.cause).Build.Logs.StreamName;
                    codebuildArn = JSON.parse(log.details.cause).Build.Arn;
                    getCodeBuildLogs = await cloudwatchlogs.getLogEvents({
                        logGroupName: logGroupName,
                        logStreamName: logStreamName
                    }).promise();
                    let subOrderId = 0;
                    for (const codebuildLogEvent of getCodeBuildLogs.events) {
                        subOrderId++;
                        const message2 = buildMessage(log, executionDetails, logDetails, codebuildLogEvent, subOrderId, codebuildArn, logGroupName, logStreamName);
                        console.log(message2);
                    }
                }
                else if (log.details.resourceType == 'codebuild' && log.type == "TaskSucceeded") {
                    logGroupName = JSON.parse(log.details.output).Build.Logs.GroupName;
                    logStreamName = JSON.parse(log.details.output).Build.Logs.StreamName;
                    codebuildArn = JSON.parse(log.details.output).Build.Arn;
                    getCodeBuildLogs = await cloudwatchlogs.getLogEvents({
                        logGroupName: logGroupName,
                        logStreamName: logStreamName
                    }).promise();
                    let subOrderId = 0;
                    for (const codebuildLogEvent of getCodeBuildLogs.events) {
                        subOrderId++;
                        const message2 = buildMessage(log, executionDetails, logDetails, codebuildLogEvent, subOrderId, codebuildArn, logGroupName, logStreamName);
                        console.log(message2);
                    }
                }
                const message = buildMessage(log, executionDetails, logDetails);
                console.log(message);
            }
        }
    }
    catch (err) {
        console.log(err + err.stack);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2NoS2luZXNpc1Byb2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xhbWJkYS9jY2hLaW5lc2lzUHJvY2Vzc29yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQy9CLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDakMsTUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUMsVUFBVSxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7QUFDMUUsSUFBSSxhQUFhLEdBQUcsSUFBSSxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFNUMsU0FBUyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsYUFBYTtJQUN0RCxNQUFNLFlBQVksR0FBRyxXQUFXLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxrREFBa0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLCtCQUErQjtRQUNuSixHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1FBQzFDLGNBQWM7UUFDZCxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUE7SUFFN0MsT0FBTyxZQUFZLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUcsZUFBZSxFQUFFLGdCQUFnQjtJQUV4SSxJQUFJLGlCQUFpQixHQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFekQsSUFBSSxRQUFRLEdBQUcsVUFBVSxDQUFD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VSxDQUFDLENBQUM7Z0JBQ2hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDdEI7U0FDRjtLQUNGO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDOUI7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB6bGliID0gcmVxdWlyZSgnemxpYicpO1xyXG5jb25zdCBBV1MgPSByZXF1aXJlKCdhd3Mtc2RrJyk7XHJcbmNvbnN0IHsgZ2V0IH0gPSByZXF1aXJlKCdodHRwcycpO1xyXG5jb25zdCBjbG91ZHdhdGNobG9ncyA9IG5ldyBBV1MuQ2xvdWRXYXRjaExvZ3Moe2FwaVZlcnNpb246ICcyMDE0LTAzLTI4J30pO1xyXG52YXIgc3RlcGZ1bmN0aW9ucyA9IG5ldyBBV1MuU3RlcEZ1bmN0aW9ucygpO1xyXG5cclxuZnVuY3Rpb24gZm9ybWF0QVdTU2VydmljZVVSTChsb2dHcm91cE5hbWUsIGxvZ1N0cmVhbU5hbWUpe1xyXG4gIGNvbnN0IGdlbmVyYXRlZFVSTCA9IGBodHRwczovLyR7cHJvY2Vzcy5lbnYuUkVHSU9OfS5jb25zb2xlLmF3cy5hbWF6b24uY29tL2Nsb3Vkd2F0Y2gvaG9tZT9yZWdpb249JHtwcm9jZXNzLmVudi5SRUdJT059I2xvZ3NWMjpsb2ctZ3JvdXBzL2xvZy1ncm91cC9gICsgXHJcbiAgICBgJHtsb2dHcm91cE5hbWUucmVwbGFjZSgvXFwvL2lnLCBcIiQyNTJGXCIpfWAgKyBcclxuICAgIGAvbG9nLWV2ZW50cy9gICtcclxuICAgIGAke2xvZ1N0cmVhbU5hbWUucmVwbGFjZSgvXFwvL2lnLCBcIiQyNTJGXCIpfWBcclxuXHJcbiAgcmV0dXJuIGdlbmVyYXRlZFVSTDtcclxufVxyXG5cclxuZnVuY3Rpb24gYnVpbGRNZXNzYWdlKHNmTG9nZXZlbnQsIGV4ZWN1dGlvbkRldGFpbHMsIHNmTG9nRGV0YWlscywgZXhlY3V0aW9uTG9nLCBzdWJPcmRlcklkLCBzdWJUYXNrQXJuLCAgc3ViTG9nR3JvdXBOYW1lLCBzdWJMb2dTdHJlYW1OYW1lKSB7XHJcblxyXG4gIGxldCBzdGVwRnVuY3Rpb25JbnB1dD1KU09OLnBhcnNlKGV4ZWN1dGlvbkRldGFpbHMuaW5wdXQpO1xyXG5cclxuICBsZXQgcGFyZW50SWQgPSBzZkxvZ2V2ZW50LmV4ZWN1dGlvbl9hcm47XHJcbiAgbGV0IGV2ZW50X3RpbWVzdGFtcCA9IHNmTG9nZXZlbnQuZXZlbnRfdGltZXN0YW1wXHJcbiAgbGV0IF9leGVjdXRpb25JZCA9IHNmTG9nZXZlbnQuZXhlY3V0aW9uX2FybjtcclxuICBsZXQgdHJhbnNhY3Rpb25JZDtcclxuXHJcbiAgaWYgKFxyXG4gICAgIXN0ZXBGdW5jdGlvbklucHV0Wydwcm9kdWNlci1pZCddIHx8XHJcbiAgICBzdGVwRnVuY3Rpb25JbnB1dFsncHJvZHVjZXItaWQnXSA9PT0gdW5kZWZpbmVkIHx8XHJcbiAgICBzdGVwRnVuY3Rpb25JbnB1dFsncHJvZHVjZXItaWQnXSA9PT0gJydcclxuICApIHtcclxuICAgIHRyYW5zYWN0aW9uSWQgPSBfZXhlY3V0aW9uSWQ7XHJcbiAgfSBlbHNlIHtcclxuICAgIHRyYW5zYWN0aW9uSWQgPSBzdGVwRnVuY3Rpb25JbnB1dFsncHJvZHVjZXItaWQnXTtcclxuICB9XHJcblxyXG4gIGxldCBldmVudExvZ0RldGFpbCA9IHNmTG9nZXZlbnQuZGV0YWlscy5yZXNvdXJjZVR5cGUgPyBgKCR7c2ZMb2dldmVudC5kZXRhaWxzLnJlc291cmNlVHlwZX0pYCA6IFwiXCI7XHJcblxyXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICBcImRhdGFUeXBlXCI6IFwiSU5URVJOQUxcIixcclxuICAgIFwib3JkZXJJZFwiOiBzdWJPcmRlcklkID8gXCJcIiA6IHNmTG9nZXZlbnQuaWQsXHJcbiAgICBcInNwYW5OYW1lXCI6IHN1Yk9yZGVySWQgPyBKU09OLnBhcnNlKHNmTG9nZXZlbnQuZGV0YWlscy5vdXRwdXQpLkJ1aWxkLlByb2plY3ROYW1lIDogc2ZMb2dldmVudC5leGVjdXRpb25fYXJuLnNwbGl0KFwiZXhlY3V0aW9uOlwiKS5wb3AoKSxcclxuICAgIFwicGFyZW50SWRcIjogcGFyZW50SWQsXHJcbiAgICBcInNvdXJjZURldGFpbFwiOiBcInN0ZXAgZnVuY3Rpb25cIixcclxuICAgIFwic291cmNlXCI6IFwiRkNDSFwiLFxyXG4gICAgXCJ1c2VySWRlbnRpZmllclwiOiBcImZjY2gtb3BlcmF0b3JcIixcclxuICAgIFwidGltZVwiOiBwYXJzZUludChldmVudF90aW1lc3RhbXApLFxyXG4gICAgXCJ0cmFuc2FjdGlvbklkXCI6IHRyYW5zYWN0aW9uSWQsXHJcbiAgICBcInNjaGVtYVZlcnNpb25cIjogXCIxLjAuMFwiLFxyXG4gICAgXCJ6b25lVHlwZVwiOiBcIklOVEVSTkFMXCIsXHJcbiAgICBcImFkZGl0aW9uYWxEYXRhXCI6IHtcclxuICAgICAgXCJ6b25lXCI6IHN0ZXBGdW5jdGlvbklucHV0LnBhcmFtcy5jdXN0b21lci56b25lLFxyXG4gICAgICBcImFjY291bnRJZGVudGlmaWVyXCI6IHByb2Nlc3MuZW52LkFDQ09VTlQsXHJcbiAgICAgIFwiYXdzUmVnaW9uXCI6IHByb2Nlc3MuZW52LlJFR0lPTixcclxuICAgICAgXCJlbnZpcm9ubWVudFwiOiBwcm9jZXNzLmVudi5TVEFHRSxcclxuICAgICAgXCJzb2Z0d2FyZVZlcnNpb25cIjogcHJvY2Vzcy5lbnYuQ0NIX1ZFUlNJT04sXHJcbiAgICAgIFwibG9nXCI6IGV4ZWN1dGlvbkxvZyA9PSBudWxsID8gYCR7c2ZMb2dldmVudC50eXBlfSAke2V2ZW50TG9nRGV0YWlsfWAgOiBleGVjdXRpb25Mb2cubWVzc2FnZSxcclxuICAgICAgXCJleGNlcHRpb25cIjogXCJcIixcclxuICAgICAgXCJhd3NTZXJ2aWNlXCI6IGV4ZWN1dGlvbkxvZyA9PSBudWxsID8gXCJzdGVwIGZ1bmN0aW9uXCIgOiBcImNvZGVidWlsZFwiLFxyXG4gICAgICBcImN1c3RvbWVyXCI6IHN0ZXBGdW5jdGlvbklucHV0LnBhcmFtcy5jdXN0b21lci5jdXN0b21lclByZWZpeCxcclxuICAgICAgXCJ0b2ZFeGVjdXRpb25JZFwiOiBcIlwiLFxyXG4gICAgICBcImZjY2hFeGVjdXRpb25JZFwiOiBfZXhlY3V0aW9uSWQsXHJcbiAgICAgIFwic3RhcnRUaW1lXCI6IGV2ZW50X3RpbWVzdGFtcCxcclxuICAgICAgXCJleGVjdXRpb25Db250ZXh0XCI6IFwiVEFTS1wiLFxyXG4gICAgICBcImxvZ0dyb3VwXCI6IGV4ZWN1dGlvbkxvZyA9PSBudWxsID8gc2ZMb2dEZXRhaWxzLmxvZ0dyb3VwIDogc3ViTG9nR3JvdXBOYW1lLFxyXG4gICAgICBcImxvZ1N0cmVhbVwiOiBleGVjdXRpb25Mb2cgPT0gbnVsbCA/IHNmTG9nRGV0YWlscy5sb2dTdHJlYW0gOnN1YkxvZ1N0cmVhbU5hbWUsXHJcbiAgICAgIFwiYXdzU2VydmljZVVSTFwiOiBleGVjdXRpb25Mb2cgPT0gbnVsbCA/IFxyXG4gICAgICAgIGZvcm1hdEFXU1NlcnZpY2VVUkwoc2ZMb2dEZXRhaWxzLmxvZ0dyb3VwLCBzZkxvZ0RldGFpbHMubG9nU3RyZWFtKSA6IFxyXG4gICAgICAgIGZvcm1hdEFXU1NlcnZpY2VVUkwoc3ViTG9nR3JvdXBOYW1lLCBzdWJMb2dTdHJlYW1OYW1lKSxcclxuICAgICAgXCJzdWJPcmRlcklkXCI6IHN1Yk9yZGVySWRcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKGV2ZW50LCBjb250ZXh0KSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGlmIChldmVudC5hd3Nsb2dzICYmIGV2ZW50LmF3c2xvZ3MuZGF0YSkge1xyXG4gICAgICBjb25zdCBwYXlsb2FkID0gQnVmZmVyLmZyb20oZXZlbnQuYXdzbG9ncy5kYXRhLCBcImJhc2U2NFwiKTtcclxuICAgICAgY29uc3QgbG9nRGV0YWlscyA9IEpTT04ucGFyc2UoemxpYi51bnppcFN5bmMocGF5bG9hZCkudG9TdHJpbmcoKSlcclxuICAgICAgY29uc3QgbG9nZXZlbnRzID0gSlNPTi5wYXJzZSh6bGliLnVuemlwU3luYyhwYXlsb2FkKS50b1N0cmluZygpKS5sb2dFdmVudHM7XHJcblxyXG4gICAgICBsZXQgZXhlY3V0aW9uQVJOID0gSlNPTi5wYXJzZShsb2dldmVudHNbMF0ubWVzc2FnZSkuZXhlY3V0aW9uX2FybjtcclxuICAgICAgY29uc3QgZXhlY3V0aW9uUGFyYW1zID0ge1xyXG4gICAgICAgIGV4ZWN1dGlvbkFybjogZXhlY3V0aW9uQVJOXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBleGVjdXRpb25EZXRhaWxzID0gYXdhaXQgc3RlcGZ1bmN0aW9ucy5kZXNjcmliZUV4ZWN1dGlvbihleGVjdXRpb25QYXJhbXMsIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xyXG4gICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCdlcnJvciA6ICcsIGVyciwgZXJyLnN0YWNrKTsgLy8gYW4gZXJyb3Igb2NjdXJyZWRcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgIC8vY29uc29sZS5sb2coJ3N1Y2Nlc3NmdWwgcmVzcG9uc2UgOiAnLCBkYXRhKTsgICAgICAgICAgIC8vIHN1Y2Nlc3NmdWwgcmVzcG9uc2VcclxuICAgICAgICB9XHJcbiAgICAgIH0pLnByb21pc2UoKTsgXHJcbiAgICAgIFxyXG4gICAgICBmb3IgKGNvbnN0IGxvZ2V2ZW50IG9mIGxvZ2V2ZW50cykge1xyXG4gICAgICAgIGNvbnN0IGxvZyA9IEpTT04ucGFyc2UobG9nZXZlbnQubWVzc2FnZSk7XHJcblxyXG4gICAgICAgICAgbGV0IGxvZ0dyb3VwTmFtZTtcclxuICAgICAgICAgIGxldCBsb2dTdHJlYW1OYW1lO1xyXG4gICAgICAgICAgbGV0IGNvZGVidWlsZEFybjtcclxuICAgICAgICAgIGxldCBnZXRDb2RlQnVpbGRMb2dzXHJcbiAgICAgICAgICBpZiAobG9nLmRldGFpbHMucmVzb3VyY2VUeXBlID09ICdjb2RlYnVpbGQnICYmIGxvZy50eXBlID09IFwiVGFza0ZhaWxlZFwiKSB7XHJcbiAgICAgICAgICAgIGxvZ0dyb3VwTmFtZSA9IEpTT04ucGFyc2UobG9nLmRldGFpbHMuY2F1c2UpLkJ1aWxkLkxvZ3MuR3JvdXBOYW1lXHJcbiAgICAgICAgICAgIGxvZ1N0cmVhbU5hbWUgPSBKU09OLnBhcnNlKGxvZy5kZXRhaWxzLmNhdXNlKS5CdWlsZC5Mb2dzLlN0cmVhbU5hbWVcclxuICAgICAgICAgICAgY29kZWJ1aWxkQXJuID0gSlNPTi5wYXJzZShsb2cuZGV0YWlscy5jYXVzZSkuQnVpbGQuQXJuO1xyXG4gICAgICAgICAgICBnZXRDb2RlQnVpbGRMb2dzID0gYXdhaXQgY2xvdWR3YXRjaGxvZ3MuZ2V0TG9nRXZlbnRzKHtcclxuICAgICAgICAgICAgICBsb2dHcm91cE5hbWU6IGxvZ0dyb3VwTmFtZSxcclxuICAgICAgICAgICAgICBsb2dTdHJlYW1OYW1lOiBsb2dTdHJlYW1OYW1lXHJcbiAgICAgICAgICAgIH0pLnByb21pc2UoKVxyXG5cclxuICAgICAgICAgICAgbGV0IHN1Yk9yZGVySWQgPSAwO1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNvZGVidWlsZExvZ0V2ZW50IG9mIGdldENvZGVCdWlsZExvZ3MuZXZlbnRzKSB7XHJcbiAgICAgICAgICAgICAgc3ViT3JkZXJJZCsrXHJcbiAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZTIgPSBidWlsZE1lc3NhZ2UobG9nLCBleGVjdXRpb25EZXRhaWxzLCBsb2dEZXRhaWxzLCBjb2RlYnVpbGRMb2dFdmVudCwgc3ViT3JkZXJJZCwgY29kZWJ1aWxkQXJuLCBsb2dHcm91cE5hbWUsIGxvZ1N0cmVhbU5hbWUpO1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfWVsc2UgaWYgKGxvZy5kZXRhaWxzLnJlc291cmNlVHlwZSA9PSAnY29kZWJ1aWxkJyAmJiBsb2cudHlwZSA9PSBcIlRhc2tTdWNjZWVkZWRcIikge1xyXG4gICAgICAgICAgICBsb2dHcm91cE5hbWUgPSBKU09OLnBhcnNlKGxvZy5kZXRhaWxzLm91dHB1dCkuQnVpbGQuTG9ncy5Hcm91cE5hbWVcclxuICAgICAgICAgICAgbG9nU3RyZWFtTmFtZSA9IEpTT04ucGFyc2UobG9nLmRldGFpbHMub3V0cHV0KS5CdWlsZC5Mb2dzLlN0cmVhbU5hbWVcclxuICAgICAgICAgICAgY29kZWJ1aWxkQXJuID0gSlNPTi5wYXJzZShsb2cuZGV0YWlscy5vdXRwdXQpLkJ1aWxkLkFybjtcclxuICAgICAgICAgICAgZ2V0Q29kZUJ1aWxkTG9ncyA9IGF3YWl0IGNsb3Vkd2F0Y2hsb2dzLmdldExvZ0V2ZW50cyh7XHJcbiAgICAgICAgICAgICAgbG9nR3JvdXBOYW1lOiBsb2dHcm91cE5hbWUsXHJcbiAgICAgICAgICAgICAgbG9nU3RyZWFtTmFtZTogbG9nU3RyZWFtTmFtZVxyXG4gICAgICAgICAgICB9KS5wcm9taXNlKClcclxuXHJcbiAgICAgICAgICAgIGxldCBzdWJPcmRlcklkID0gMDtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBjb2RlYnVpbGRMb2dFdmVudCBvZiBnZXRDb2RlQnVpbGRMb2dzLmV2ZW50cykge1xyXG4gICAgICAgICAgICAgIHN1Yk9yZGVySWQrK1xyXG4gICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UyID0gYnVpbGRNZXNzYWdlKGxvZywgZXhlY3V0aW9uRGV0YWlscywgbG9nRGV0YWlscywgY29kZWJ1aWxkTG9nRXZlbnQsIHN1Yk9yZGVySWQsIGNvZGVidWlsZEFybiwgbG9nR3JvdXBOYW1lLCBsb2dTdHJlYW1OYW1lKTtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlMik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gYnVpbGRNZXNzYWdlKGxvZywgZXhlY3V0aW9uRGV0YWlscywgbG9nRGV0YWlscyk7XHJcbiAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9IGNhdGNoIChlcnIpIHtcclxuICAgIGNvbnNvbGUubG9nKGVyciArIGVyci5zdGFjayk7XHJcbiAgfVxyXG59OyJdfQ==